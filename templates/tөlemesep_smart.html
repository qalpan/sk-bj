<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <title>SK-BJ ‚Äî –ñ–æ—Å–ø–∞—Ä –∂”ô–Ω–µ –¢”©–ª–µ–º –ë–∞“õ—ã–ª–∞—É—ã</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 20px; }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 100%; margin: auto; }
        .controls { display: flex; gap: 15px; margin-bottom: 20px; background: #e9ecef; padding: 15px; border-radius: 8px; align-items: center; }
        
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #34495e; color: white; }
        
        /* –ñ–æ—Å–ø–∞—Ä –∂”ô–Ω–µ –§–∞–∫—Ç —Å—Ç–∏–ª—ñ */
        .cell-split { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .plan { color: #7f8c8d; font-size: 10px; border-bottom: 1px solid #eee; width: 100%; padding-bottom: 2px; }
        .fact { color: #27ae60; font-weight: bold; padding-top: 2px; }
        
        .footer-row { background: #2c3e50; color: white; font-weight: bold; }
        .total-col { background: #e8f5e9; font-weight: bold; }
        .debt-col { background: #fff3e0; font-weight: bold; color: #e67e22; }
        .btn { padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; background: #3498db; color: white; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>üè¢ ”ò–∫—ñ–º—à—ñ –ø–∞–Ω–µ–ª—ñ: “ö—ã–∑–º–µ—Ç—Ç–µ—Ä –±–æ–π—ã–Ω—à–∞ –µ—Å–µ–ø (–ñ–æ—Å–ø–∞—Ä / –¢”©–ª–µ–º)</h2>

    <div class="controls">
        <button class="btn" onclick="fetchData()">üîÑ –ú”ô–ª—ñ–º–µ—Ç—Ç—ñ –∂–∞“£–∞—Ä—Ç—É</button>
        <select id="monthSelector" onchange="renderTable()" style="padding: 8px; border-radius: 4px;"></select>
        <span id="syncStatus" style="margin-left: auto; font-weight: bold;">–°—Ç–∞—Ç—É—Å: –ö“Ø—Ç—É–¥–µ...</span>
    </div>

    <table>
        <thead>
            <tr>
                <th>–ü”ô—Ç–µ—Ä ‚Ññ</th>
                <th>–ê—É–¥–∞–Ω</th>
                <th>“Æ–π –∫“Ø—Ç—ñ–º—ñ<br><small>(–ñ–æ—Å–ø–∞—Ä/–§–∞–∫—Ç)</small></th>
                <th>–¢–∞–∑–∞–ª—ã“õ<br><small>(–ñ–æ—Å–ø–∞—Ä/–§–∞–∫—Ç)</small></th>
                <th>–ö“Ø–∑–µ—Ç<br><small>(–ñ–æ—Å–ø–∞—Ä/–§–∞–∫—Ç)</small></th>
                <th>–ñ—ã–ª—É<br><small>(–ñ–æ—Å–ø–∞—Ä/–§–∞–∫—Ç)</small></th>
                <th>–ö–∞–ø.–∂”©–Ω–¥–µ—É<br><small>(–ñ–æ—Å–ø–∞—Ä/–§–∞–∫—Ç)</small></th>
                <th style="background:#2e7d32; color:white;">–ê–π–ª—ã“õ –ë–ê–†–õ–´“í–´<br><small>(–ñ–æ—Å–ø–∞—Ä/–¢”©–ª–µ–Ω–¥—ñ)</small></th>
                <th style="background:#d35400; color:white;">–ñ–∞–ª–ø—ã “ö–ê–†–´–ó</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
        <tfoot id="tableFooter"></tfoot>
    </table>
</div>

<script>
    let db = { apartments: [] };

    async function fetchData() {
        document.getElementById('syncStatus').innerText = "üîÑ –ñ“Ø–∫—Ç–µ–ª—É–¥–µ...";
        try {
            const res = await fetch('/api/data/');
            db = await res.json();
            
            const selector = document.getElementById('monthSelector');
            const months = db.apartments[0].ledger.map(l => l.month);
            selector.innerHTML = months.map((m, i) => 
                `<option value="${i}" ${i === months.length - 1 ? 'selected' : ''}>${m}</option>`
            ).join('');

            renderTable();
            document.getElementById('syncStatus').innerText = "‚úÖ –î–∞–π—ã–Ω";
        } catch (e) {
            document.getElementById('syncStatus').innerText = "‚ùå “ö–∞—Ç–µ";
        }
    }

    function renderTable() {
        const mIdx = document.getElementById('monthSelector').value;
        const tbody = document.getElementById('tableBody');
        const tfoot = document.getElementById('tableFooter');
        tbody.innerHTML = '';
        
        let totalStats = {
            maint: {p:0, f:0}, clean: {p:0, f:0}, sec: {p:0, f:0}, 
            heat: {p:0, f:0}, cap: {p:0, f:0}, monthly: {p:0, f:0}, debt: 0
        };

        db.apartments.forEach(apt => {
            const L = apt.ledger[mIdx];
            const ch = L.charges || {};
            
            // 1. paymentTransactions —ñ—à—ñ–Ω–µ–Ω –±–∞—Ä–ª—ã“õ —Ç”©–ª–µ–º–¥–µ—Ä–¥—ñ –∂–∏–Ω–∞“õ—Ç–∞–π–º—ã–∑
            let fact = { maint: 0, clean: 0, sec: 0, heat: 0, cap: 0 };
            let totalFact = 0;

            if (L.paymentTransactions && L.paymentTransactions.length > 0) {
                L.paymentTransactions.forEach(trans => {
                    const am = trans.amounts || {};
                    fact.maint += (am.maint || 0);
                    fact.clean += (am.clean || 0);
                    fact.sec += (am.sec || 0);
                    fact.heat += (am.heat || 0);
                    fact.cap += (am.cap || 0);
                });
            }
            totalFact = fact.maint + fact.clean + fact.sec + fact.heat + fact.cap;

            // –ñ–∏—ã–Ω—Ç—ã“õ—Ç–∞—Ä–¥—ã –µ—Å–µ–ø—Ç–µ—É
            totalStats.maint.p += ch.maint; totalStats.maint.f += fact.maint;
            totalStats.clean.p += ch.clean; totalStats.clean.f += fact.clean;
            totalStats.sec.p += ch.sec;     totalStats.sec.f += fact.sec;
            totalStats.heat.p += ch.heat;   totalStats.heat.f += fact.heat;
            totalStats.cap.p += ch.cap;     totalStats.cap.f += fact.cap;
            totalStats.monthly.p += (L.totalMonthlyCharge || 0);
            totalStats.monthly.f += totalFact;
            totalStats.debt += (L.accumulated.overall || 0);

            tbody.innerHTML += `
                <tr>
                    <td><b>${apt.id}</b></td>
                    <td>${apt.area}</td>
                    <td><div class="cell-split"><span class="plan">${ch.maint}</span><span class="fact">${fact.maint || 0}</span></div></td>
                    <td><div class="cell-split"><span class="plan">${ch.clean}</span><span class="fact">${fact.clean || 0}</span></div></td>
                    <td><div class="cell-split"><span class="plan">${ch.sec}</span><span class="fact">${fact.sec || 0}</span></div></td>
                    <td><div class="cell-split"><span class="plan">${ch.heat}</span><span class="fact">${fact.heat || 0}</span></div></td>
                    <td><div class="cell-split"><span class="plan">${ch.cap}</span><span class="fact">${fact.cap || 0}</span></div></td>
                    <td class="total-col">${L.totalMonthlyCharge} / <span style="color:#27ae60">${totalFact}</span></td>
                    <td class="debt-col" style="color: ${L.accumulated.overall > 0 ? '#e74c3c' : '#27ae60'}">${L.accumulated.overall.toLocaleString()}</td>
                </tr>
            `;
        });

        // "–ò—Ç–æ–≥–æ" –∂–æ–ª—ã
        tfoot.innerHTML = `
            <tr class="footer-row">
                <td colspan="2">–ë–ê–†–õ–´“í–´ (–ñ–æ—Å–ø–∞—Ä/–§–∞–∫—Ç):</td>
                <td>${totalStats.maint.p.toFixed(0)} / ${totalStats.maint.f.toFixed(0)}</td>
                <td>${totalStats.clean.p.toFixed(0)} / ${totalStats.clean.f.toFixed(0)}</td>
                <td>${totalStats.sec.p.toFixed(0)} / ${totalStats.sec.f.toFixed(0)}</td>
                <td>${totalStats.heat.p.toFixed(0)} / ${totalStats.heat.f.toFixed(0)}</td>
                <td>${totalStats.cap.p.toFixed(0)} / ${totalStats.cap.f.toFixed(0)}</td>
                <td style="background:#27ae60">${totalStats.monthly.p.toFixed(0)} / ${totalStats.monthly.f.toFixed(0)}</td>
                <td style="background:#d35400">${totalStats.debt.toLocaleString()} ‚Ç∏</td>
            </tr>
        `;
    }

    window.onload = fetchData;
</script>
</body>
</html>
