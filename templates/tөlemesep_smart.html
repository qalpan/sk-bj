<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <title>SK-BJ ‚Äî –ñ–æ—Å–ø–∞—Ä –∂”ô–Ω–µ –¢”©–ª–µ–º –ï—Å–µ–±—ñ</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f4f7f6; margin: 20px; }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 1500px; margin: auto; }
        
        h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }

        /* –ë–∞—Å“õ–∞—Ä—É –ø–∞–Ω–µ–ª—ñ */
        .controls { display: flex; gap: 15px; margin-bottom: 20px; background: #eef2f3; padding: 15px; border-radius: 8px; align-items: center; }
        .btn { padding: 10px 18px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
        .btn-update { background: #3498db; }
        .btn-save { background: #27ae60; }
        
        /* –ö–µ—Å—Ç–µ –¥–∏–∑–∞–π–Ω—ã */
        table { width: 100%; border-collapse: collapse; background: white; font-size: 13px; }
        th { background: #34495e; color: white; padding: 12px; border: 1px solid #ddd; }
        td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        
        /* –ñ–æ—Å–ø–∞—Ä / –¢”©–ª–µ–º –±”©–ª—ñ–Ω—ñ—Å—ñ */
        .split-cell { display: flex; justify-content: space-around; align-items: center; }
        .plan { color: #7f8c8d; font-size: 11px; font-weight: normal; }
        .fact { color: #27ae60; font-weight: bold; border-left: 1px solid #eee; padding-left: 5px; min-width: 40px; }
        
        .total-monthly { background: #e8f5e9; font-weight: bold; }
        .debt-cell { background: #fff3e0; color: #e67e22; font-weight: bold; }
        .debt-over { color: #e74c3c; }

        /* “ö–æ—Ä—ã—Ç—ã–Ω–¥—ã –∂–æ–ª—ã */
        .footer-row { background: #2c3e50; color: white; font-weight: bold; }
        .footer-row td { padding: 15px; border-top: 2px solid #333; }
        .footer-split { display: block; font-size: 11px; color: #bdc3c7; }

        #syncStatus { font-size: 14px; font-weight: bold; color: #2c3e50; margin-left: auto; }
    </style>
</head>
<body>

<div class="container">
    <h2>“ö–∞—Ä–∂—ã–ª—ã“õ –ë–∞“õ—ã–ª–∞—É: –ñ–æ—Å–ø–∞—Ä / –¢”©–ª–µ–º</h2>

    <div class="controls">
        <button class="btn btn-update" onclick="fetchData()">üîÑ –î–µ—Ä–µ–∫—Ç—ñ –∂–∞“£–∞—Ä—Ç—É</button>
        <select id="monthSelector" onchange="renderTable()" style="padding: 10px; border-radius: 5px;"></select>
        <button class="btn btn-save" onclick="saveData()">üíæ –°–∞“õ—Ç–∞—É (Render)</button>
        <div id="syncStatus">–ö“Ø—Ç—É–¥–µ...</div>
    </div>

    <table>
        <thead>
            <tr>
                <th rowspan="2">–ü”ô—Ç–µ—Ä ‚Ññ</th>
                <th rowspan="2">–ê—É–¥–∞–Ω</th>
                <th>“Æ–π –∫“Ø—Ç—ñ–º—ñ</th>
                <th>–¢–∞–∑–∞–ª—ã“õ</th>
                <th>–ö“Ø–∑–µ—Ç</th>
                <th>–ñ—ã–ª—É</th>
                <th>–ö–∞–ø.–∂”©–Ω–¥–µ—É</th>
                <th style="background:#2e7d32">–ê–π–ª—ã“õ (–ñ/–¢)</th>
                <th style="background:#d35400">–ñ–∞–ª–ø—ã “ö–∞—Ä—ã–∑</th>
            </tr>
            <tr style="font-size: 10px; background: #2c3e50;">
                <th>–ñ–æ—Å–ø–∞—Ä / –§–∞–∫—Ç</th>
                <th>–ñ–æ—Å–ø–∞—Ä / –§–∞–∫—Ç</th>
                <th>–ñ–æ—Å–ø–∞—Ä / –§–∞–∫—Ç</th>
                <th>–ñ–æ—Å–ø–∞—Ä / –§–∞–∫—Ç</th>
                <th>–ñ–æ—Å–ø–∞—Ä / –§–∞–∫—Ç</th>
                <th>–ñ–∞–ª–ø—ã –ñ / –¢</th>
                <th>“ö–∞–ª–¥—ã“õ</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
        <tfoot id="tableFooter"></tfoot>
    </table>
</div>

<script>
    let db = { apartments: [] };

    async function fetchData() {
        document.getElementById('syncStatus').innerText = "üîÑ –ñ“Ø–∫—Ç–µ–ª—É–¥–µ...";
        try {
            const res = await fetch('/api/data/');
            db = await res.json();
            
            const selector = document.getElementById('monthSelector');
            const months = db.apartments[0].ledger.map(l => l.month);
            selector.innerHTML = months.map((m, i) => 
                `<option value="${i}" ${i === months.length - 1 ? 'selected' : ''}>${m}</option>`
            ).join('');

            renderTable();
            document.getElementById('syncStatus').innerText = "‚úÖ –î–µ—Ä–µ–∫—Ç–µ—Ä –¥–∞–π—ã–Ω";
        } catch (e) {
            document.getElementById('syncStatus').innerText = "‚ùå “ö–∞—Ç–µ –æ—Ä—ã–Ω –∞–ª–¥—ã";
        }
    }

    function renderTable() {
        const mIdx = document.getElementById('monthSelector').value;
        const tbody = document.getElementById('tableBody');
        const tfoot = document.getElementById('tableFooter');
        tbody.innerHTML = '';
        
        let totals = {
            maint: {p:0, f:0}, clean: {p:0, f:0}, sec: {p:0, f:0}, 
            heat: {p:0, f:0}, cap: {p:0, f:0}, monthly: {p:0, f:0}, debt: 0
        };

        db.apartments.forEach(apt => {
            const L = apt.ledger[mIdx];
            const ch = L.charges;
            // –¢”©–ª–µ–º–¥–µ—Ä–¥—ñ –±–∞–∑–∞–¥–∞–Ω –∞–ª—É (–µ–≥–µ—Ä paid –æ–±—ä–µ–∫—Ç—ñ—Å—ñ –±–æ–ª–º–∞—Å–∞, 0 –¥–µ–ø –µ—Å–µ–ø—Ç–µ–π–º—ñ–∑)
            const pd = L.paid || { maint: 0, clean: 0, sec: 0, heat: 0, cap: 0 };
            const totalPd = L.totalPaid || 0;

            // –ñ–∏—ã–Ω—Ç—ã“õ—Ç–∞—Ä–¥—ã –µ—Å–µ–ø—Ç–µ—É
            totals.maint.p += ch.maint; totals.maint.f += pd.maint;
            totals.clean.p += ch.clean; totals.clean.f += pd.clean;
            totals.sec.p += ch.sec;     totals.sec.f += pd.sec;
            totals.heat.p += ch.heat;   totals.heat.f += pd.heat;
            totals.cap.p += ch.cap;     totals.cap.f += pd.cap;
            totals.monthly.p += L.totalMonthlyCharge;
            totals.monthly.f += totalPd;
            totals.debt += L.accumulated.overall;

            tbody.innerHTML += `
                <tr>
                    <td><b>${apt.id}</b></td>
                    <td>${apt.area}</td>
                    <td><div class="split-cell"><span class="plan">${ch.maint}</span><span class="fact">${pd.maint}</span></div></td>
                    <td><div class="split-cell"><span class="plan">${ch.clean}</span><span class="fact">${pd.clean}</span></div></td>
                    <td><div class="split-cell"><span class="plan">${ch.sec}</span><span class="fact">${pd.sec}</span></div></td>
                    <td><div class="split-cell"><span class="plan">${ch.heat}</span><span class="fact">${pd.heat}</span></div></td>
                    <td><div class="split-cell"><span class="plan">${ch.cap}</span><span class="fact">${pd.cap}</span></div></td>
                    <td class="total-monthly">${L.totalMonthlyCharge} / <span style="color:#27ae60">${totalPd}</span></td>
                    <td class="debt-cell ${L.accumulated.overall > 0 ? 'debt-over' : ''}">${L.accumulated.overall.toLocaleString()}</td>
                </tr>
            `;
        });

        // –ê—Å—Ç—ã“£“ì—ã “õ–æ—Ä—ã—Ç—ã–Ω–¥—ã –∂–æ–ª—ã
        tfoot.innerHTML = `
            <tr class="footer-row">
                <td colspan="2">–ñ–ê–õ–ü–´ –ï–°–ï–ü:</td>
                <td>${totals.maint.p}<span class="footer-split">—Ç”©–ª–µ–Ω–¥—ñ: ${totals.maint.f}</span></td>
                <td>${totals.clean.p}<span class="footer-split">—Ç”©–ª–µ–Ω–¥—ñ: ${totals.clean.f}</span></td>
                <td>${totals.sec.p}<span class="footer-split">—Ç”©–ª–µ–Ω–¥—ñ: ${totals.sec.f}</span></td>
                <td>${totals.heat.p}<span class="footer-split">—Ç”©–ª–µ–Ω–¥—ñ: ${totals.heat.f}</span></td>
                <td>${totals.cap.p}<span class="footer-split">—Ç”©–ª–µ–Ω–¥—ñ: ${totals.cap.f}</span></td>
                <td style="background:#27ae60">${totals.monthly.p} / ${totals.monthly.f}</td>
                <td style="background:#d35400">${totals.debt.toLocaleString()} ‚Ç∏</td>
            </tr>
        `;
    }

    async function saveData() {
        const res = await fetch('/api/data/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(db)
        });
        if (res.ok) alert("–°–∞“õ—Ç–∞–ª–¥—ã!");
    }

    window.onload = fetchData;
</script>
</body>
</html>
