<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <title>Smart –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å 2025</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 20px; }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #2c3e50; color: white; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-card span { display: block; font-size: 20px; font-weight: bold; margin-top: 5px; }
        .controls { display: flex; gap: 15px; margin-bottom: 25px; padding: 15px; background: #e9ecef; border-radius: 8px; align-items: center; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #dee2e6; padding: 10px; text-align: center; font-size: 13px; }
        th { background: #34495e; color: white; }
        .footer-row { background: #ecf0f1; font-weight: bold; }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; }
        .btn-save { background: #27ae60; }
        .btn-load { background: #3498db; }
    </style>
</head>
<body>

<div class="container">
    <h2>–¢“±—Ä“ì—ã–Ω “Ø–π –±–∞—Å“õ–∞—Ä—É –∂“Ø–π–µ—Å—ñ</h2>

    <div class="stats-grid">
        <div class="stat-card">–ü”ô—Ç–µ—Ä–ª–µ—Ä —Å–∞–Ω—ã <span id="totalApts">0</span></div>
        <div class="stat-card">–ñ–∞–ª–ø—ã –∞—É–¥–∞–Ω <span id="totalArea">0 –º¬≤</span></div>
        <div class="stat-card">–ê–π–ª—ã“õ –µ—Å–µ–ø <span id="monthTotal">0 ‚Ç∏</span></div>
        <div class="stat-card">–ñ–∞–ª–ø—ã “õ–∞—Ä—ã–∑ <span id="overallDebt">0 ‚Ç∏</span></div>
    </div>
    
    <div class="controls">
        <button class="btn btn-load" onclick="fetchData()">üîÑ –ñ–∞“£–∞—Ä—Ç—É</button>
        <select id="monthSelector" onchange="renderTable()" style="padding:8px; border-radius:5px;"></select>
        <button class="btn btn-save" onclick="saveData()">üíæ –°–∞“õ—Ç–∞—É</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>–ü”ô—Ç–µ—Ä ‚Ññ</th>
                <th>–ê—É–¥–∞–Ω</th>
                <th>“Æ–π –∫“Ø—Ç—ñ–º—ñ</th>
                <th>–¢–∞–∑–∞–ª—ã“õ</th>
                <th>–ö“Ø–∑–µ—Ç</th>
                <th>–ñ—ã–ª—É</th>
                <th>–ö–∞–ø.–∂”©–Ω–¥–µ—É</th>
                <th><b>–ê–π–ª—ã“õ —Å–æ–º–∞</b></th>
                <th><b>–ñ–∞–ª–ø—ã “ö–∞—Ä—ã–∑</b></th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
        <tfoot>
            <tr class="footer-row" id="tableFooter"></tr>
        </tfoot>
    </table>
</div>

<script>
    let db = { apartments: [] };

    async function fetchData() {
        const res = await fetch('/api/data/');
        db = await res.json();
        const selector = document.getElementById('monthSelector');
        const months = db.apartments[0].ledger.map(l => l.month);
        selector.innerHTML = months.map((m, i) => `<option value="${i}" ${i===months.length-1?'selected':''}>${m}</option>`).join('');
        renderTable();
    }

    function renderTable() {
        const mIdx = document.getElementById('monthSelector').value;
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        let totals = { area:0, maint:0, clean:0, sec:0, heat:0, cap:0, monthly:0, debt:0 };

        db.apartments.forEach(apt => {
            const L = apt.ledger[mIdx];
            totals.area += apt.area;
            totals.maint += L.charges.maint;
            totals.clean += L.charges.clean;
            totals.sec += L.charges.sec;
            totals.heat += L.charges.heat;
            totals.cap += L.charges.cap;
            totals.monthly += L.totalMonthlyCharge;
            totals.debt += L.accumulated.overall;

            tbody.innerHTML += `
                <tr>
                    <td>${apt.id}</td>
                    <td>${apt.area}</td>
                    <td>${L.charges.maint}</td>
                    <td>${L.charges.clean}</td>
                    <td>${L.charges.sec}</td>
                    <td>${L.charges.heat}</td>
                    <td>${L.charges.cap}</td>
                    <td style="background:#f9f9f9">${L.totalMonthlyCharge}</td>
                    <td style="color:red"><b>${L.accumulated.overall}</b></td>
                </tr>
            `;
        });

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞–Ω—ã –∂–∞“£–∞—Ä—Ç—É
        document.getElementById('totalApts').innerText = db.apartments.length;
        document.getElementById('totalArea').innerText = totals.area.toFixed(1) + " –º¬≤";
        document.getElementById('monthTotal').innerText = totals.monthly.toLocaleString() + " ‚Ç∏";
        document.getElementById('overallDebt').innerText = totals.debt.toLocaleString() + " ‚Ç∏";

        // –ö–µ—Å—Ç–µ –∞—Å—Ç—ã–Ω–¥–∞“ì—ã “õ–æ—Ä—ã—Ç—ã–Ω–¥—ã
        document.getElementById('tableFooter').innerHTML = `
            <td>–ñ–∞–ª–ø—ã:</td>
            <td>${totals.area.toFixed(1)}</td>
            <td>${totals.maint.toFixed(0)}</td>
            <td>${totals.clean.toFixed(0)}</td>
            <td>${totals.sec.toFixed(0)}</td>
            <td>${totals.heat.toFixed(0)}</td>
            <td>${totals.cap.toFixed(0)}</td>
            <td>${totals.monthly.toFixed(0)}</td>
            <td style="color:red">${totals.debt.toFixed(0)}</td>
        `;
    }

    async function saveData() {
        await fetch('/api/data/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(db)
        });
        alert("–°”ô—Ç—Ç—ñ —Å–∞“õ—Ç–∞–ª–¥—ã!");
    }
    window.onload = fetchData;
</script>
</body>
</html>
