<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <title>Smart –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å ‚Äî –¢”©–ª–µ–º –ï—Å–µ–±—ñ</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 20px; color: #333; }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 1500px; margin: auto; }
        
        .controls { display: flex; gap: 15px; margin-bottom: 20px; background: #e9ecef; padding: 15px; border-radius: 8px; align-items: center; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; color: white; background: #3498db; }
        
        table { width: 100%; border-collapse: collapse; background: white; font-size: 13px; }
        th { background: #34495e; color: white; padding: 12px; border: 1px solid #dee2e6; }
        td { border: 1px solid #dee2e6; padding: 8px; text-align: center; }

        /* –ñ–æ—Å–ø–∞—Ä –º–µ–Ω –§–∞–∫—Ç –±”©–ª—ñ–º—ñ */
        .cell-split { display: flex; flex-direction: column; min-width: 70px; }
        .plan { color: #7f8c8d; font-size: 11px; border-bottom: 1px solid #eee; padding-bottom: 2px; }
        .fact { color: #27ae60; font-weight: bold; padding-top: 2px; }
        
        .total-row { background: #e8f5e9; font-weight: bold; }
        .footer-row { background: #2c3e50; color: white; font-weight: bold; }
        #syncStatus { margin-left: auto; font-weight: bold; }

        .service-cell {
        vertical-align: top;
        padding: 5px !important;
        min-width: 120px;
    }
    .plan-val {
        font-size: 11px;
        color: #7f8c8d;
        border-bottom: 1px dashed #ccc;
        margin-bottom: 5px;
        background: #fafafa;
    }
    .fact-list {
        text-align: left;
        font-size: 10.5px;
    }
    .trans-item {
        background: #e8f5e9; /* –ñ–∞—Å—ã–ª–¥–∞—É —Ç“Ø—Å —Ç”©–ª–µ–º–¥–µ—Ä “Ø—à—ñ–Ω */
        border-radius: 4px;
        padding: 3px 5px;
        margin-bottom: 3px;
        border-left: 3px solid #2e7d32;
    }
    .trans-item b {
        color: #1b5e20;
    }
    .no-pay {
        color: #bdc3c7;
        font-style: italic;
    }

/* –¢”©–ª–µ–º–¥–µ—Ä–¥—ñ“£ –∂–µ–∫–µ –±–ª–æ–∫—Ç–∞—Ä—ã–Ω–∞ –∞—Ä–Ω–∞–ª“ì–∞–Ω —Å—Ç–∏–ª—å */
    .payment-badge {
        background: #e8f5e9;
        border-left: 3px solid #2e7d32;
        margin: 4px 0;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        text-align: left;
    }
    .bank-name { color: #1565c0; font-weight: bold; text-transform: uppercase; }
    .pay-date { color: #666; font-style: italic; }
    .pay-amount { font-weight: bold; color: #2e7d32; display: block; }        
    </style>
</head>
<body>

<div class="container">
    <h2>üìä “ö—ã–∑–º–µ—Ç—Ç–µ—Ä –±–æ–π—ã–Ω—à–∞ –µ—Å–µ–ø: –ñ–æ—Å–ø–∞—Ä / –¢”©–ª–µ–º</h2>

    <div class="controls">
        <button class="btn" onclick="fetchData()">üîÑ –ë–∞–∑–∞–Ω—ã –∂–∞“£–∞—Ä—Ç—É</button>
        <select id="monthSelector" onchange="renderTable()" style="padding: 8px; border-radius: 5px;"></select>
        <span id="syncStatus">–ö“Ø—Ç—É–¥–µ...</span>
    </div>

    <table id="mainTable">
        <thead>
            <tr>
                <th>–ü”ô—Ç–µ—Ä ‚Ññ</th>
                <th>–ê—É–¥–∞–Ω</th>
                <th>“Æ–π –∫“Ø—Ç—ñ–º—ñ<br><small>–ñ–æ—Å–ø–∞—Ä/–§–∞–∫—Ç</small></th>
                <th>–¢–∞–∑–∞–ª—ã“õ<br><small>–ñ–æ—Å–ø–∞—Ä/–§–∞–∫—Ç</small></th>
                <th>–ö“Ø–∑–µ—Ç<br><small>–ñ–æ—Å–ø–∞—Ä/–§–∞–∫—Ç</small></th>
                <th>–ñ—ã–ª—É<br><small>–ñ–æ—Å–ø–∞—Ä/–§–∞–∫—Ç</small></th>
                <th>–ö–∞–ø.–∂”©–Ω–¥–µ—É<br><small>–ñ–æ—Å–ø–∞—Ä/–§–∞–∫—Ç</small></th>
                <th style="background:#27ae60; color:white;">–ë–ê–†–õ–´“í–´ (–ñ/–¢)</th>
                <th style="background:#e67e22; color:white;">“ö–ê–†–´–ó</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
        <tfoot id="tableFooter"></tfoot>
    </table>
</div>

<script>
    let db = { apartments: [] };

    async function fetchData() {
        document.getElementById('syncStatus').innerText = "üîÑ –ñ“Ø–∫—Ç–µ–ª—É–¥–µ...";
        try {
            const res = await fetch('/api/data/');
            db = await res.json();
            
            const selector = document.getElementById('monthSelector');
            const months = db.apartments[0].ledger.map(l => l.month);
            selector.innerHTML = months.map((m, i) => 
                `<option value="${i}" ${i === months.length - 1 ? 'selected' : ''}>${m}</option>`
            ).join('');

            renderTable();
            document.getElementById('syncStatus').innerText = "‚úÖ –î–µ—Ä–µ–∫—Ç–µ—Ä –∂–∞“£–∞—Ä—Ç—ã–ª–¥—ã";
        } catch (e) {
            document.getElementById('syncStatus').innerText = "‚ùå “ö–∞—Ç–µ: –î–µ—Ä–µ–∫ –∞–ª—ã–Ω–±–∞–¥—ã";
        }
    }

function renderTable() {
    const mIdx = document.getElementById('monthSelector').value;
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    
    // –ë–∞—Ä–ª—ã“õ –ø”ô—Ç–µ—Ä–ª–µ—Ä –±–æ–π—ã–Ω—à–∞ –∂–∞–ª–ø—ã –∂–∏—ã–Ω—Ç—ã“õ—Ç–∞—Ä (–ò—Ç–æ–≥–æ)
    let totalPlan = 0;
    let totalFact = 0;

    db.apartments.forEach(apt => {
        const L = apt.ledger[mIdx];
        const charges = L.charges || {};
        
        // --- –¢”®–õ–ï–ú–î–ï–†–î–Ü –ë”®–õ–ï–ö –®–´“í–ê–†–£ –õ–û–ì–ò–ö–ê–°–´ ---
        const getServiceFact = (key) => {
            if (!L.paymentTransactions || L.paymentTransactions.length === 0) return 0;
            // –û—Å—ã “õ—ã–∑–º–µ—Ç —Ç“Ø—Ä—ñ –±–æ–π—ã–Ω—à–∞ –±–∞—Ä–ª—ã“õ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–ª–∞—Ä–¥—ã “õ–æ—Å–∞–º—ã–∑
            return L.paymentTransactions.reduce((sum, trans) => {
                return sum + (trans.amounts && trans.amounts[key] ? trans.amounts[key] : 0);
            }, 0);
        };

        // ”ò—Ä “õ—ã–∑–º–µ—Ç –±–æ–π—ã–Ω—à–∞ —Ñ–∞–∫—Ç —Å–æ–º–∞–ª–∞—Ä–¥—ã –µ—Å–µ–ø—Ç–µ–π–º—ñ–∑
        const fact = {
            maint: getServiceFact('maint'),
            clean: getServiceFact('clean'),
            sec: getServiceFact('sec'),
            heat: getServiceFact('heat'),
            cap: getServiceFact('cap')
        };

        const aptTotalFact = fact.maint + fact.clean + fact.sec + fact.heat + fact.cap;
        totalPlan += (L.totalMonthlyCharge || 0);
        totalFact += aptTotalFact;

        // –ö–µ—Å—Ç–µ –∂–æ–ª—ã–Ω “õ“±—Ä–∞—Å—Ç—ã—Ä—É
        tbody.innerHTML += `
            <tr>
                <td><b>${apt.id}</b></td>
                <td>${apt.area}</td>
                <td>
                    <div style="color:#888; font-size:11px;">${charges.maint}</div>
                    <div style="color:green; font-weight:bold;">${fact.maint > 0 ? fact.maint : '0'}</div>
                </td>
                <td>
                    <div style="color:#888; font-size:11px;">${charges.clean}</div>
                    <div style="color:green; font-weight:bold;">${fact.clean > 0 ? fact.clean : '0'}</div>
                </td>
                <td>
                    <div style="color:#888; font-size:11px;">${charges.sec}</div>
                    <div style="color:green; font-weight:bold;">${fact.sec > 0 ? fact.sec : '0'}</div>
                </td>
                <td>
                    <div style="color:#888; font-size:11px;">${charges.heat}</div>
                    <div style="color:green; font-weight:bold;">${fact.heat > 0 ? fact.heat : '0'}</div>
                </td>
                <td>
                    <div style="color:#888; font-size:11px;">${charges.cap}</div>
                    <div style="color:green; font-weight:bold;">${fact.cap > 0 ? fact.cap : '0'}</div>
                </td>
                <td style="background:#f0f9f0;">
                    ${L.totalMonthlyCharge} / <span style="color:green; font-weight:bold;">${aptTotalFact}</span>
                </td>
                <td style="color:${L.accumulated.overall > 0 ? 'red' : 'green'}; font-weight:bold;">
                    ${L.accumulated.overall.toLocaleString()}
                </td>
            </tr>
        `;
    });
}

    window.onload = fetchData;
</script>
</body>
</html>
