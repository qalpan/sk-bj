<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <title>SK-BJ ‚Äî –§–∞–π–ª–¥—ã –ñ“Ø–∫—Ç–µ—É –ü–∞–Ω–µ–ª—ñ</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 20px; font-size: 13px; }
        .admin-box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .file-upload-section { 
            background: #e3f2fd; padding: 20px; border: 2px dashed #2196f3; 
            border-radius: 8px; text-align: center; margin-bottom: 20px; 
        }
        .btn { padding: 10px 20px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; color: white; }
        .btn-load { background: #2196f3; margin-left: 10px; }
        .btn-save { background: #27ae60; margin-top: 10px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: #34495e; color: white; padding: 10px; border: 1px solid #ddd; }
        td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .trans-info { color: #666; font-size: 11px; display: block; }
    </style>
</head>
<body>

<div class="admin-box">
    <h2>üìÇ –î–µ—Ä–µ–∫—Ç–µ—Ä –±–∞–∑–∞—Å—ã–Ω –±–∞—Å“õ–∞—Ä—É</h2>
    
    <div class="file-upload-section">
        <label style="font-weight: bold;">JSON –§–∞–π–ª–¥—ã —Ç–∞“£–¥–∞“£—ã–∑: </label>
        <input type="file" id="fileInput" accept=".json">
        <button class="btn btn-load" onclick="loadLocalFile()">üì• –ö–µ—Å—Ç–µ–≥–µ –∂“Ø–∫—Ç–µ—É</button>
        <p style="font-size: 11px; color: #555; margin-top: 10px;">
            (–ö–æ–º–ø—å—é—Ç–µ—Ä–¥–µ–≥—ñ —Å–æ“£“ì—ã —Å–∞“õ—Ç–∞–ª“ì–∞–Ω "kz_tulem_database..." —Ñ–∞–π–ª—ã–Ω —Ç–∞“£–¥–∞“£—ã–∑)
        </p>
    </div>

    <div id="status" style="font-weight: bold; color: #27ae60; margin-bottom: 10px;"></div>

    <table>
        <thead>
            <tr>
                <th>‚Ññ</th>
                <th>–ê—É–¥–∞–Ω</th>
                <th>–ê–π–ª—ã“õ –ñ–∞–ª–ø—ã (–ñ–æ—Å–ø–∞—Ä / –¢”©–ª–µ–º)</th>
                <th>–¢”©–ª–µ–º –º”ô–ª—ñ–º–µ—Ç—Ç–µ—Ä—ñ</th>
                <th>“ö–∞—Ä—ã–∑</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr><td colspan="5">–î–µ—Ä–µ–∫—Ç–µ—Ä –∂“Ø–∫—Ç–µ–ª–º–µ–≥–µ–Ω. –§–∞–π–ª–¥—ã —Ç–∞“£–¥–∞“£—ã–∑.</td></tr>
        </tbody>
    </table>

    <button class="btn btn-save" onclick="saveModifiedData()" style="display:none;" id="saveBtn">üíæ –ñ–∞“£–∞ —Ñ–∞–π–ª–¥—ã —Å–∞“õ—Ç–∞—É</button>
</div>

<script>
    let db = { apartments: [] };

    // –°–∞–Ω–¥–∞—Ä–¥—ã —Ñ–æ—Ä–º–∞—Ç—Ç–∞—É —Ñ—É–Ω–∫—Ü–∏—è—Å—ã (–°—ñ–∑ —Å“±—Ä–∞“ì–∞–Ω 5 065 526,21 —Ñ–æ—Ä–º–∞—Ç—ã)
    function fNum(num) {
        if (num === undefined || num === null || isNaN(num)) return "0";
        let parts = num.toFixed(2).split(".");
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        let fraction = parts[1].replace(/0+$/, "");
        return fraction === "" ? parts[0] : parts[0] + "," + fraction;
    }

    // –§–ê–ô–õ–î–´ –û“ö–£ –§–£–ù–ö–¶–ò–Ø–°–´
    function loadLocalFile() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];

        if (!file) {
            alert("”®—Ç—ñ–Ω—ñ—à, –∞–ª–¥—ã–º–µ–Ω —Ñ–∞–π–ª–¥—ã —Ç–∞“£–¥–∞“£—ã–∑!");
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                db = JSON.parse(e.target.result);
                document.getElementById('status').innerText = "‚úÖ –§–∞–π–ª —Å”ô—Ç—Ç—ñ –∂“Ø–∫—Ç–µ–ª–¥—ñ: " + file.name;
                document.getElementById('saveBtn').style.display = "block";
                renderTable();
            } catch (err) {
                alert("“ö–∞—Ç–µ: –§–∞–π–ª —Ñ–æ—Ä–º–∞—Ç—ã –¥“±—Ä—ã—Å –µ–º–µ—Å!");
            }
        };
        reader.readAsText(file);
    }

    // –ö–ï–°–¢–ï–ù–Ü –®–´“í–ê–†–£
    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        const mIdx = 0; // “ö–∞“£—Ç–∞—Ä –∞–π—ã –º—ã—Å–∞–ª—ã–Ω–¥–∞

        db.apartments.forEach(apt => {
            const L = apt.ledger[mIdx] || { charges: {}, paymentTransactions: [], accumulated: { overall: 0 } };
            const rowPaid = (L.paymentTransactions || []).reduce((sum, t) => 
                sum + Object.values(t.amounts).reduce((a, b) => a + b, 0), 0
            );
            const rowCharge = L.totalMonthlyCharge || 0;
            const rowDebt = L.accumulated ? L.accumulated.overall : 0;

            const transDetails = (L.paymentTransactions || []).map(t => 
                `${t.paymentSource || ''} (${t.date || ''})`
            ).join(', ');

            tbody.innerHTML += `
                <tr>
                    <td><b>${apt.id}</b></td>
                    <td>${fNum(apt.area)}</td>
                    <td style="background: #e8f5e9;"><b>${fNum(rowCharge)} / ${fNum(rowPaid)}</b></td>
                    <td><span class="trans-info">${transDetails || '–¢”©–ª–µ–º –∂–æ“õ'}</span></td>
                    <td style="color: ${rowDebt > 0 ? 'red' : 'green'}">${fNum(rowDebt)}</td>
                </tr>
            `;
        });
    }

    // ”®–ó–ì–ï–†–Ü–°–¢–ï–†–î–Ü –ñ–ê“¢–ê –§–ê–ô–õ –†–ï–¢–Ü–ù–î–ï –°–ê“ö–¢–ê–£
    function saveModifiedData() {
        const dataStr = JSON.stringify(db, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "kz_tulem_database_updated.json";
        a.click();
        URL.revokeObjectURL(url);
    }
</script>

</body>
</html>
