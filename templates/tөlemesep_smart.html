<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <title>Smart –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å ‚Äî SK-BJ</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 20px; color: #333; }
        .container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); max-width: 1400px; margin: auto; }
        
        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞—Ä—Ç–∞–ª–∞—Ä—ã */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: #2c3e50; color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-card span { display: block; font-size: 22px; font-weight: bold; margin-top: 8px; color: #3498db; }
        
        /* –ë–∞—Å“õ–∞—Ä—É –±–∞—Ç—ã—Ä–º–∞–ª–∞—Ä—ã */
        .controls { display: flex; gap: 15px; margin-bottom: 25px; padding: 20px; background: #e9ecef; border-radius: 10px; align-items: center; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; color: white; transition: 0.3s; }
        .btn-save { background: #27ae60; } .btn-save:hover { background: #219150; }
        .btn-load { background: #3498db; } .btn-load:hover { background: #2980b9; }
        .btn-split { background: #f39c12; }
        
        /* –ö–µ—Å—Ç–µ —Å—Ç–∏–ª—ñ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; font-size: 14px; }
        th, td { border: 1px solid #dee2e6; padding: 12px; text-align: center; }
        th { background: #34495e; color: white; position: sticky; top: 0; }
        tr:nth-child(even) { background: #f8f9fa; }
        tr:hover { background: #edf2f7; }
        
        .footer-row { background: #2c3e50 !important; color: white; font-weight: bold; }
        .commercial-row { border-left: 5px solid #e74c3c; }
        
        /* –ú–æ–¥–∞–ª—å–¥—ñ —Ç–µ—Ä–µ–∑–µ */
        .modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:30px; border-radius:12px; box-shadow: 0 10px 50px rgba(0,0,0,0.5); z-index:1000; width: 350px; }
        .modal input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; }
    </style>
</head>
<body>

<div class="overlay" id="overlay" onclick="closeSplitModal()"></div>

<div class="container">
    <h2>–¢“±—Ä“ì—ã–Ω “Æ–π “ö–∞—Ä–∂—ã—Å—ã–Ω –ë–∞—Å“õ–∞—Ä—É (Smart –ü–∞–Ω–µ–ª—å)</h2>

    <div class="stats-grid">
        <div class="stat-card">–ü”ô—Ç–µ—Ä–ª–µ—Ä —Å–∞–Ω—ã <span id="statApts">0</span></div>
        <div class="stat-card">–ñ–∞–ª–ø—ã –∞—É–¥–∞–Ω <span id="statArea">0 –º¬≤</span></div>
        <div class="stat-card">–ê–π–ª—ã“õ –∂–æ—Å–ø–∞—Ä <span id="statMonthly">0 ‚Ç∏</span></div>
        <div class="stat-card">–ñ–∞–ª–ø—ã –±–µ—Ä–µ—à–µ–∫ <span id="statDebt">0 ‚Ç∏</span></div>
    </div>
    
    <div class="controls">
        <button class="btn btn-load" onclick="fetchData()">üîÑ –ë–∞–∑–∞–Ω—ã –∂–∞“£–∞—Ä—Ç—É</button>
        <select id="monthSelector" onchange="renderTable()" style="padding: 10px; border-radius: 5px;"></select>
        <button class="btn btn-save" onclick="saveData()">üíæ Render-–≥–µ —Å–∞“õ—Ç–∞—É</button>
        <button class="btn btn-split" onclick="openSplitModal()">‚úÇÔ∏è –ü”ô—Ç–µ—Ä–¥—ñ –±”©–ª—É</button>
        <span id="syncStatus" style="margin-left: auto; font-weight: bold; color: #2c3e50;">–°—Ç–∞—Ç—É—Å: –ö“Ø—Ç—É–¥–µ...</span>
    </div>

    <table id="mainTable">
        <thead>
            <tr>
                <th>–ü”ô—Ç–µ—Ä ‚Ññ</th>
                <th>–ê—É–¥–∞–Ω (–º¬≤)</th>
                <th>“Æ–π –∫“Ø—Ç—ñ–º—ñ</th>
                <th>–¢–∞–∑–∞–ª—ã“õ</th>
                <th>–ö“Ø–∑–µ—Ç</th>
                <th>–ñ—ã–ª—É</th>
                <th>–ö–∞–ø. –∂”©–Ω–¥–µ—É</th>
                <th style="background:#27ae60">–ê–π–ª—ã“õ –ë–∞—Ä–ª—ã“ì—ã</th>
                <th style="background:#e67e22">–ñ–∞–ª–ø—ã “ö–∞—Ä—ã–∑</th>
                <th>”ò—Ä–µ–∫–µ—Ç</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
        <tfoot id="tableFooter"></tfoot>
    </table>
</div>

<div id="splitModal" class="modal">
    <h3>–ü”ô—Ç–µ—Ä–¥—ñ –ë”©–ª—É (Split)</h3>
    <input type="text" id="splitOldId" placeholder="–ü”ô—Ç–µ—Ä ‚Ññ (ID)">
    <input type="number" id="splitArea1" placeholder="–ê—É–¥–∞–Ω 1 (–º¬≤)" step="0.01">
    <input type="number" id="splitArea2" placeholder="–ê—É–¥–∞–Ω 2 (–º¬≤)" step="0.01">
    <button class="btn btn-save" style="width:100%" onclick="executeSplit()">–†–∞—Å—Ç–∞—É</button>
    <button class="btn" style="width:100%; margin-top:10px; background:#95a5a6" onclick="closeSplitModal()">–ñ–∞–±—É</button>
</div>

<script>
    let db = { apartments: [] };
    const API_URL = '/api/data/';

    // –î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ —Å–µ—Ä–≤–µ—Ä–¥–µ–Ω –∞–ª—É
    async function fetchData() {
        document.getElementById('syncStatus').innerText = "üîÑ –ñ“Ø–∫—Ç–µ–ª—É–¥–µ...";
        try {
            const res = await fetch(API_URL);
            db = await res.json();
            
            if (!db.apartments || db.apartments.length === 0) {
                alert("–ë–∞–∑–∞ –±–æ—Å!");
                return;
            }

            // –ê–π–ª–∞—Ä–¥—ã —Å–µ–ª–µ–∫—Ç–æ—Ä“ì–∞ “õ–æ—Å—É
            const selector = document.getElementById('monthSelector');
            const firstApt = db.apartments[0];
            const months = firstApt.ledger.map(l => l.month);
            selector.innerHTML = months.map((m, i) => 
                `<option value="${i}" ${i === months.length - 1 ? 'selected' : ''}>${m}</option>`
            ).join('');

            renderTable();
            document.getElementById('syncStatus').innerText = "‚úÖ –°—Ç–∞—Ç—É—Å: –ñ–∞“£–∞—Ä—Ç—ã–ª–¥—ã";
        } catch (e) {
            document.getElementById('syncStatus').innerText = "‚ùå “ö–∞—Ç–µ: –ë–∞–∑–∞ –æ“õ—ã–ª–º–∞–¥—ã";
        }
    }

    // –ö–µ—Å—Ç–µ–Ω—ñ –∂”ô–Ω–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞–Ω—ã —à—ã“ì–∞—Ä—É
    function renderTable() {
        const mIdx = document.getElementById('monthSelector').value;
        const tbody = document.getElementById('tableBody');
        const tfoot = document.getElementById('tableFooter');
        tbody.innerHTML = '';
        
        let totals = { area: 0, maint: 0, clean: 0, sec: 0, heat: 0, cap: 0, monthly: 0, debt: 0 };

        db.apartments.forEach(apt => {
            const L = apt.ledger[mIdx];
            const ch = L.charges;

            // –ï—Å–µ–ø—Ç–µ—É–ª–µ—Ä
            totals.area += apt.area;
            totals.maint += ch.maint;
            totals.clean += ch.clean;
            totals.sec += ch.sec;
            totals.heat += ch.heat;
            totals.cap += ch.cap;
            totals.monthly += L.totalMonthlyCharge;
            totals.debt += L.accumulated.overall;

            const tr = document.createElement('tr');
            if (ch.maint > 3000) tr.className = 'commercial-row'; // –ö–æ–º–º–µ—Ä—Ü–∏—è–ª—ã“õ –Ω—ã—Å–∞–Ω–¥–∞—Ä–¥—ã –±–µ–ª–≥—ñ–ª–µ—É

            tr.innerHTML = `
                <td><b>${apt.id}</b></td>
                <td>${apt.area}</td>
                <td>${ch.maint.toLocaleString()}</td>
                <td>${ch.clean.toLocaleString()}</td>
                <td>${ch.sec.toLocaleString()}</td>
                <td>${ch.heat.toLocaleString()}</td>
                <td>${ch.cap.toLocaleString()}</td>
                <td style="background:#f1f8e9"><b>${L.totalMonthlyCharge.toLocaleString()}</b></td>
                <td style="color:#e67e22"><b>${L.accumulated.overall.toLocaleString()}</b></td>
                <td><button class="btn btn-load" style="padding:5px 10px" onclick="window.open('/pater/${apt.id}/')">üëÅÔ∏è</button></td>
            `;
            tbody.appendChild(tr);
        });

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞—Ä—Ç–∞–ª–∞—Ä—ã–Ω –∂–∞“£–∞—Ä—Ç—É
        document.getElementById('statApts').innerText = db.apartments.length;
        document.getElementById('statArea').innerText = totals.area.toFixed(1) + " –º¬≤";
        document.getElementById('statMonthly').innerText = totals.monthly.toLocaleString() + " ‚Ç∏";
        document.getElementById('statDebt').innerText = totals.debt.toLocaleString() + " ‚Ç∏";

        // “ö–æ—Ä—ã—Ç—ã–Ω–¥—ã (–ò—Ç–æ–≥–æ) –∂–æ–ª—ã
        tfoot.innerHTML = `
            <tr class="footer-row">
                <td>–ñ–ê–õ–ü–´:</td>
                <td>${totals.area.toFixed(1)}</td>
                <td>${totals.maint.toLocaleString()}</td>
                <td>${totals.clean.toLocaleString()}</td>
                <td>${totals.sec.toLocaleString()}</td>
                <td>${totals.heat.toLocaleString()}</td>
                <td>${totals.cap.toLocaleString()}</td>
                <td style="background:#27ae60">${totals.monthly.toLocaleString()} ‚Ç∏</td>
                <td style="background:#d35400">${totals.debt.toLocaleString()} ‚Ç∏</td>
                <td>-</td>
            </tr>
        `;
    }

    // –î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ —Å–∞“õ—Ç–∞—É
    async function saveData() {
        document.getElementById('syncStatus').innerText = "‚è≥ –°–∞“õ—Ç–∞–ª—É–¥–∞...";
        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(db)
            });
            if (res.ok) {
                alert("–î–µ—Ä–µ–∫—Ç–µ—Ä Render –±–∞–∑–∞—Å—ã–Ω–∞ —Å”ô—Ç—Ç—ñ —Å–∞“õ—Ç–∞–ª–¥—ã!");
                document.getElementById('syncStatus').innerText = "‚úÖ –°–∞“õ—Ç–∞–ª–¥—ã";
            }
        } catch (e) {
            alert("–°–∞“õ—Ç–∞—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ –∫–µ—Ç—Ç—ñ!");
        }
    }

    // –ü”ô—Ç–µ—Ä–¥—ñ –±”©–ª—É —Ñ—É–Ω–∫—Ü–∏—è—Å—ã
    function openSplitModal() { 
        document.getElementById('splitModal').style.display = 'block'; 
        document.getElementById('overlay').style.display = 'block';
    }
    function closeSplitModal() { 
        document.getElementById('splitModal').style.display = 'none'; 
        document.getElementById('overlay').style.display = 'none';
    }

    function executeSplit() {
        const oldId = document.getElementById('splitOldId').value;
        const a1 = parseFloat(document.getElementById('splitArea1').value);
        const a2 = parseFloat(document.getElementById('splitArea2').value);

        const idx = db.apartments.findIndex(a => a.id.toString() === oldId.toString());
        if (idx === -1) return alert("–ü”ô—Ç–µ—Ä —Ç–∞–±—ã–ª–º–∞–¥—ã!");

        // –ñ–∞“£–∞ –ø”ô—Ç–µ—Ä –Ω—ã—Å–∞–Ω—ã–Ω –∂–∞—Å–∞—É
        const newApt = JSON.parse(JSON.stringify(db.apartments[idx]));
        newApt.id = oldId + "–∞";
        newApt.area = a2;
        newApt.account = ""; // –ñ–∞“£–∞ –¥–µ—Ä–±–µ—Å —à–æ—Ç “õ–∞–∂–µ—Ç
        
        // Ledger-–¥–µ–≥—ñ –±–∞—Ä–ª—ã“õ –∞–π–ª–∞—Ä–¥—ã“£ —Å–æ–º–∞—Å—ã–Ω –∂–∞“£–∞ –∞—É–¥–∞–Ω“ì–∞ “õ–∞—Ä–∞–π “õ–∞–π—Ç–∞ –µ—Å–µ–ø—Ç–µ—É (“õ–∞—Ä–∞–ø–∞–π—ã–º –º—ã—Å–∞–ª)
        newApt.ledger.forEach(L => {
            L.accumulated.overall = 0; // –ñ–∞“£–∞ –ø”ô—Ç–µ—Ä —Ç–∞–∑–∞ –±–∞–ª–∞–Ω—Å–ø–µ–Ω
        });

        db.apartments[idx].area = a1; // –ï—Å–∫—ñ –ø”ô—Ç–µ—Ä –∞—É–¥–∞–Ω—ã–Ω –∞–∑–∞–π—Ç—É
        db.apartments.push(newApt);

        renderTable();
        closeSplitModal();
        alert("–ë”©–ª—ñ–Ω–¥—ñ! –ï–Ω–¥—ñ '–°–∞“õ—Ç–∞—É' –±–∞—Ç—ã—Ä–º–∞—Å—ã–Ω –±–∞—Å—É–¥—ã “±–º—ã—Ç–ø–∞“£—ã–∑.");
    }

    window.onload = fetchData;
</script>
</body>
</html>
