<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <title>–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å: Smart –ï—Å–µ–ø—Ç–µ—É</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 20px; }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .controls { display: flex; gap: 15px; margin-bottom: 25px; padding: 15px; background: #e9ecef; border-radius: 8px; align-items: center; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #dee2e6; padding: 12px; text-align: center; }
        th { background: #2c3e50; color: white; }
        tr:nth-child(even) { background: #f8f9fa; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; color: white; }
        .btn-save { background: #27ae60; }
        .btn-split { background: #f39c12; }
        .btn-load { background: #3498db; }
        .commercial-row { background: #fff3cd !important; font-weight: bold; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:30px; border-radius:12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index:1000; border: 1px solid #ccc; }
    </style>
</head>
<body>

<div class="container">
    <h2>–¢“±—Ä“ì—ã–Ω “Æ–π “ö–∞—Ä–∂—ã—Å—ã–Ω –ë–∞—Å“õ–∞—Ä—É (Smart –ü–∞–Ω–µ–ª—å)</h2>
    
    <div class="controls">
        <button class="btn btn-load" onclick="fetchDataFromServer()">–ë–∞–∑–∞–Ω—ã Render-–¥–µ–Ω –ñ“Ø–∫—Ç–µ—É</button>
        <button class="btn btn-save" onclick="saveDataToServer()">”®–∑–≥–µ—Ä—ñ—Å—Ç–µ—Ä–¥—ñ Render-–≥–µ –°–∞“õ—Ç–∞—É</button>
        <button class="btn btn-split" onclick="openSplitModal()">–ü”ô—Ç–µ—Ä–¥—ñ –ë”©–ª—É (Split)</button>
        <span id="syncStatus">–°—Ç–∞—Ç—É—Å: –ö“Ø—Ç—É–¥–µ...</span>
    </div>

    <table id="mainTable">
        <thead>
            <tr>
                <th>–ü”ô—Ç–µ—Ä ‚Ññ</th>
                <th>–î–µ—Ä–±–µ—Å –®–æ—Ç</th>
                <th>–ê—É–¥–∞–Ω (–º¬≤)</th>
                <th>–¢–∞—Ä–∏—Ñ</th>
                <th>“ö—ã–∑–º–µ—Ç—Ç–µ—Ä</th>
                <th>–ê“ì—ã–º–¥–∞“ì—ã “ö–∞—Ä—ã–∑</th>
                <th>”ò—Ä–µ–∫–µ—Ç</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<div id="splitModal" class="modal">
    <h3>–ü”ô—Ç–µ—Ä–¥—ñ –ë”©–ª—É –õ–æ–≥–∏–∫–∞—Å—ã</h3>
    <p>–ú—ã—Å–∞–ª—ã: 9 –ø”ô—Ç–µ—Ä–¥—ñ 9 –∂”ô–Ω–µ 9–∞-“ì–∞ –±”©–ª—É</p>
    <input type="text" id="splitOldId" placeholder="–ï—Å–∫—ñ –ø”ô—Ç–µ—Ä ‚Ññ (ID)">
    <input type="number" id="splitArea1" placeholder="–ñ–∞“£–∞ –∞—É–¥–∞–Ω 1 (–º¬≤)" step="0.1">
    <input type="number" id="splitArea2" placeholder="–ñ–∞“£–∞ –∞—É–¥–∞–Ω 2 (–º¬≤)" step="0.1">
    <br><br>
    <button class="btn btn-save" onclick="executeSplit()">–ë”©–ª—É–¥—ñ –†–∞—Å—Ç–∞—É</button>
    <button class="btn btn-load" onclick="closeSplitModal()" style="background:#95a5a6">–ë–æ–ª–¥—ã—Ä–º–∞—É</button>
</div>

<script>
    let apartments = [];
    const API_URL = 'https://sk-bj.onrender.com/api'; // –°—ñ–∑–¥—ñ“£ Render –∞–¥—Ä–µ—Å—ñ“£—ñ–∑

    // 1. –°–ï–†–í–ï–†–î–ï–ù –î–ï–†–ï–ö–¢–ï–†–î–Ü –ê–õ–£
    async function fetchDataFromServer() {
        document.getElementById('syncStatus').innerText = "–ñ“Ø–∫—Ç–µ–ª—É–¥–µ...";
        try {
            const response = await fetch(`${API_URL}/get-all-apartments`);
            apartments = await response.json();
            renderTable();
            document.getElementById('syncStatus').innerText = "–°—Ç–∞—Ç—É—Å: –î–µ—Ä–µ–∫—Ç–µ—Ä –∂–∞“£–∞—Ä—Ç—ã–ª–¥—ã";
        } catch (e) {
            alert("–°–µ—Ä–≤–µ—Ä–≥–µ “õ–æ—Å—ã–ª—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã!");
        }
    }

    // 2. –¢–ê–†–ò–§–¢–Ü –ê–í–¢–û–ú–ê–¢–¢–´ –ê–ù–´“ö–¢–ê–£ (ID –ë–û–ô–´–ù–®–ê)
    function getRate(aptId) {
        const commercial = ["1", "15", "16"];
        return commercial.includes(aptId.toString()) ? 60 : 40;
    }

    // 3. –ö–ï–°–¢–ï–ù–Ü –®–´“í–ê–†–£
    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        apartments.forEach((apt, index) => {
            const rate = getRate(apt.id);
            const tr = document.createElement('tr');
            if (rate === 60) tr.className = 'commercial-row';

            tr.innerHTML = `
                <td><b>${apt.id}</b></td>
                <td>${apt.account || '<small><i>–ñ–æ“õ</i></small>'}</td>
                <td>${apt.area} –º¬≤</td>
                <td>${rate} —Ç“£–≥</td>
                <td>${apt.services.sec ? 'üìπ' : ''} ${apt.services.clean ? 'üßπ' : ''}</td>
                <td>${apt.balance} —Ç“£–≥</td>
                <td>
                    <button onclick="viewReceipt('${apt.id}')">üëÅÔ∏è –ö”©—Ä—É</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 4. –ü”ò–¢–ï–†–î–Ü –ë”®–õ–£ (SPLIT)
    function openSplitModal() { document.getElementById('splitModal').style.display = 'block'; }
    function closeSplitModal() { document.getElementById('splitModal').style.display = 'none'; }

    function executeSplit() {
        const oldId = document.getElementById('splitOldId').value;
        const area1 = parseFloat(document.getElementById('splitArea1').value);
        const area2 = parseFloat(document.getElementById('splitArea2').value);

        const idx = apartments.findIndex(a => a.id === oldId);
        if (idx === -1) return alert("–ü”ô—Ç–µ—Ä —Ç–∞–±—ã–ª–º–∞–¥—ã!");

        // 9–∞ –ø”ô—Ç–µ—Ä—ñ–Ω –∂–∞—Å–∞—É
        const newApt = {
            id: oldId + "–∞",
            account: "", // –î–µ—Ä–±–µ—Å —à–æ—Ç ”ô–∑—ñ—Ä–≥–µ –±–æ—Å
            area: area2,
            balance: 0,
            services: { ...apartments[idx].services },
            history: []
        };

        apartments[idx].area = area1; // –ï—Å–∫—ñ –ø”ô—Ç–µ—Ä –∞—É–¥–∞–Ω—ã–Ω –∞–∑–∞–π—Ç—É
        apartments.push(newApt);

        renderTable();
        closeSplitModal();
        alert(`${oldId} –ø”ô—Ç–µ—Ä—ñ –µ–∫—ñ–≥–µ –±”©–ª—ñ–Ω–¥—ñ. –ï–Ω–¥—ñ Render-–≥–µ —Å–∞“õ—Ç–∞—É–¥—ã –±–∞—Å—ã“£—ã–∑.`);
    }

    // 5. –°–ï–†–í–ï–†–ì–ï –°–ê“ö–¢–ê–£
    async function saveDataToServer() {
        document.getElementById('syncStatus').innerText = "–°–∞“õ—Ç–∞–ª—É–¥–∞...";
        try {
            const response = await fetch(`${API_URL}/save-data`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(apartments)
            });
            if (response.ok) alert("–ë–∞—Ä–ª—ã“õ ”©–∑–≥–µ—Ä—ñ—Å—Ç–µ—Ä Render –±–∞–∑–∞—Å—ã–Ω–∞ —Å”ô—Ç—Ç—ñ –∂–∞–∑—ã–ª–¥—ã!");
        } catch (e) {
            alert("–°–∞“õ—Ç–∞—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ —à—ã“õ—Ç—ã!");
        }
    }

    function viewReceipt(id) {
        window.open(`pater.html?id=${id}`, '_blank');
    }
</script>

</body>
</html>
